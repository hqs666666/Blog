@{
    ViewBag.Title = "授权记录";
}

<style>
    #grant {
        width: 65%;
        margin: 0 auto;
        padding: 40px 0;
    }

    .title {
        text-align: center;
        margin: 20px 0;
        font-size: 24px;
    }
</style>

<div id="grant">
    <div class="title">客户端应用访问记录</div>
    <el-table :data="tableData"
              border
              style="width: 100%">
        <el-table-column prop="ClientId"
                         label="客户端Id"
                         width="180">
        </el-table-column>
        <el-table-column prop="ClientName"
                         label="客户端名称"
                         width="180">
        </el-table-column>
        <el-table-column prop="Created"
                         label="授权时间">
        </el-table-column>
        <el-table-column prop="Expires"
                         label="过期时间">
        </el-table-column>
        <el-table-column prop="IdentityGrantNames"
                         label="身份授权">
        </el-table-column>
        <el-table-column prop="ApiGrantNames"
                         label="API授权">
        </el-table-column>
        <el-table-column fixed="right"
                         label="操作"
                         width="100">
            <template slot-scope="scope">
                <el-button @@click="handleClick(scope.row)" type="text" size="small">撤销访问权限</el-button>
            </template>
        </el-table-column>
    </el-table>
</div>

@section scripts
    {
    <script>
        var app = new Vue({
            el: "#grant",
            data() {
                return {
                    tableData: []
                }
            },
            created() {
                this.getData();
            },
            methods: {
                handleClick(row) {
                    this.$confirm('此操作将永久删除该记录, 是否继续?',
                        '提示',
                        {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(() => {
                            fetch('/Grants/Revoke?clientId=' + row.ClientId,
                                {
                                    method: 'POST'
                                }).then(response => response.json())
                                .then(data => {
                                    if (data.result) {
                                        this.getData();
                                        this.$notify({
                                            title: '成功',
                                            message: '删除成功',
                                            type: 'success'
                                        });
                                    } else {
                                        this.$notify.error({
                                            title: '错误',
                                            message: data.message
                                        });
                                    }
                                });
                        }).catch
                        (() => {
                            this.$notify.error({
                                title: '错误',
                                message: '删除失败'
                            });
                        });
                },
                getData() {
                    this.tableData = [];
                    fetch('/Grants/GetGrantData')
                        .then(response => response.json())
                        .then(data => {
                            for (var i = 0; i < data.length; i++) {
                                var json = {
                                    ClientId: data[i].clientId,
                                    ClientName: data[i].clientName,
                                    Created: data[i].created,
                                    Expires: data[i].expires,
                                    IdentityGrantNames: data[i].identityGrantNames.join(),
                                    ApiGrantNames: data[i].apiGrantNames.join()
                                }
                                this.tableData.push(json);
                            }
                        });
                }
            }
        });
    </script>
}
